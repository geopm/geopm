#
#  Copyright (c) 2015 - 2024, Intel Corporation
#  SPDX-License-Identifier: BSD-3-Clause
#

name: Coverity Scan

on:
  schedule:
    - cron: '0 11 * * *'

  workflow_dispatch:

permissions: read-all

jobs:
  coverity:
    runs-on: ubuntu-latest
    env:
      CC: clang
      CXX: clang++
    steps:
    - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
    - name: install system dependencies
      run: sudo apt-get update && sudo apt-get install libelf-dev mpich libmpich-dev libomp-15-dev libsystemd-dev liburing-dev python3-gi python3-yaml libcap-dev zlib1g-dev
    - name: configure libgeopmd dir
      working-directory: libgeopmd
      run: ./autogen.sh && ./configure || (cat config.log && false)
    - uses: geopm/coverity-scan-action@39d3248b335ad08da39933c9927d0eeb588203c2 # v1.8.0
      with:
        token: ${{ secrets.COVERITY_SCAN_TOKEN }}
        email: ${{ secrets.COVERITY_SCAN_EMAIL }}
        command: make -C libgeopmd -O -j$(getconf _NPROCESSORS_CONF)
    - name: configure libgeopm dir
      working-directory: libgeopm
      run: ./autogen.sh && ./configure --enable-beta || (cat config.log && false)
    - uses: geopm/coverity-scan-action@39d3248b335ad08da39933c9927d0eeb588203c2 # v1.8.0
      with:
        token: ${{ secrets.COVERITY_SCAN_TOKEN }}
        email: ${{ secrets.COVERITY_SCAN_EMAIL }}
        command: make -C libgeopm -O -j$(getconf _NPROCESSORS_CONF)
